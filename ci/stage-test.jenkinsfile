stage('test') {
    if (env.build_type == "manual") {
        try {
            timeout(time: 15, unit: 'MINUTES') {
                sh '''
                    cd Pal/regression                    
                    if test -n "$SGX"
                    then
                        gramine-test --sgx build -v
                    else
                        gramine-test build -v
                    fi
                    python3 -m pytest -v --junit-xml pal-regression.xml
                '''
            }
        } catch (Exception e){
            env.build_ok = false
            sh 'echo "PAL Test Failed"'
        } finally {
            junit 'Pal/regression/pal-regression.xml'
        }

        try {
            timeout(time: 15, unit: 'MINUTES') {

                sh '''
                    cd LibOS/shim/test/regression
                    if test -n "$SGX"
                    then                    
                        RA_CLIENT_SPID=${ra_client_spid} gramine-test --sgx build -v
                    else
                        RA_CLIENT_SPID=${ra_client_spid} gramine-test build -v
                    fi
                '''
                if (env.node_label == "graphene_dcap") {
                    sh '''
                        cd LibOS/shim/test/regression
                        python3 -m pytest -v -k "not large_mmap" --junit-xml libos-regression.xml 
                    '''
                } else {
                     sh '''
                        cd LibOS/shim/test/regression
                        python3 -m pytest -v -k "not attestation" --junit-xml libos-regression.xml 
                    '''
                }
            }
        } catch (Exception e){
            env.build_ok = false
            sh 'echo "LibOS Test Failed"'
        } finally {
            junit 'LibOS/shim/test/regression/libos-regression.xml'
        }

        try {
            timeout(time: 15, unit: 'MINUTES') {
                sh '''
                    cd LibOS/shim/test/fs
                    if test -n "$SGX"
                    then                     
                        gramine-test --sgx build -v
                    else
                        gramine-test build -v
                    fi
                    python3 -m pytest -v --junit-xml fs.xml
                '''
            }
        } catch (Exception e){
            env.build_ok = false
            sh 'echo "LibOS Test Failed"'
        } finally {
            junit 'LibOS/shim/test/fs/*.xml'
        }
    }
}
