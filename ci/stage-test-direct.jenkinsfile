stage('test-direct') {
    env.no_cpu = sh(script:'nproc', returnStdout: true).trim()
    try {
        timeout(time: 30, unit: 'MINUTES') {
            sh '''
                cd LibOS/shim/test/ltp
                cp -f toml_files/tests_direct.toml tests.toml
                os_release_id=$(grep -oP '(?<=^ID=).+' /etc/os-release | tr -d '"')
                os_version=$(grep -oP 'VERSION_ID="\\K[\\d.]+' /etc/os-release)
                if [ "${os_release_id}" = "rhel" ] || [ "${os_release_id}" = "centos" ]
                then
                    cp -f manifest_CentOS_RHEL.template manifest.template
                fi
                if [ "${os_version}" = "18.04" ]
                then
                    cp -f manifest_18_04.template manifest.template
                fi
                if [ "${os_version}" = "20.04" ] || [ "${os_version}" = "21.10" ]
                then
                    cp -f manifest_20_04_21_10.template manifest.template
                fi
                make ${MAKEOPTS} -f Makefile.LTP all 
            '''
            // Run tests in a separate block, so that Jenkins measures build time and run time
            // separately
            sh '''
                cd LibOS/shim/test/ltp
                python3 -m pytest -v  --junit-xml=ltp.xml
            '''            
            /*
            sh '''
                cd LibOS/shim/test/ltp
                export CFG=ltp-sudo-syscalls.cfg
                export LTPSCENARIO=$PWD/install/runtest/syscalls-sudo
                make -f Makefile.LTP ltp_results_2.xml LTPCFG=$CFG LTPTESTFILE=$LTPSCENARIO
            '''
            */
        }
    } catch (Exception e){
        env.build_ok = false
        sh 'echo "LTP Test Failed"'
    } finally {
        archiveArtifacts 'LibOS/shim/test/ltp/ltp.xml'
        junit 'LibOS/shim/test/ltp/ltp.xml'
    }

    try{
        timeout(time: 5, unit: 'MINUTES') {
            sh '''
                cd CI-Examples/python
                make ${MAKEOPTS} ${ARCH_LIB_OPT} all
                make check
            '''
        }
    } catch (Exception e){
        env.build_ok = false
        sh 'echo "Python Example Test Failed"'
    }

    try{
        timeout(time: 5, unit: 'MINUTES') {
            sh '''
                cd CI-Examples/bash
                sed -i '/@rm OUTPUT/d' Makefile
                make ${MAKEOPTS} ${ARCH_LIB_OPT} all
                make ${MAKEOPTS} regression
            '''
        }
    } catch (Exception e){
        env.build_ok = false
        sh 'echo "Bash Example Test Failed"'
    }

    if(env.gcc_dump_machine != "x86_64-redhat-linux") 
    {
        try {
            timeout(time: 10, unit: 'MINUTES') {
                sh '''
                    cd CI-Examples/memcached
                    make ${MAKEOPTS} ${ARCH_LIB_OPT} all
                    make start-gramine-server &
                    ../../Scripts/wait_for_server 5 127.0.0.1 11211
                    # memcslap populates server but doesn't report errors, use
                    # memcached-tool for this (must return two lines of stats)
                    memcslap --servers=127.0.0.1 --concurrency=8
                    src/scripts/memcached-tool 127.0.0.1 | wc -l | grep -w "2" 2>&1 | tee OUTPUT.txt
                '''
            }
        } catch (Exception e){
            env.build_ok = false
            sh 'echo "Memcached Example Test Failed"'
        }
    }

    try {
        timeout(time: 10, unit: 'MINUTES') {
            sh '''
                cd CI-Examples/redis
                if .ci/isdistro xenial
                then
                    USE_SELECT=1
                    export USE_SELECT
                fi
                make ${MAKEOPTS} ${ARCH_LIB_OPT} all
                make start-gramine-server &
                ../../Scripts/wait_for_server 5 127.0.0.1 6379
                ./src/src/redis-benchmark 2>&1 | tee OUTPUT
            '''
        }
    } catch (Exception e){
        env.build_ok = false
        sh 'echo "Redis Example Test Failed"'
    }

    try {
        timeout(time: 10, unit: 'MINUTES') {
            sh '''
                cd CI-Examples/lighttpd
                make ${MAKEOPTS} ${ARCH_LIB_OPT} all
                make ${MAKEOPTS} start-gramine-server &
                ../../Scripts/wait_for_server 5 127.0.0.1 8003
                LOOP=1 CONCURRENCY_LIST="1 32" ../common_tools/benchmark-http.sh 127.0.0.1:8003
            '''
        }
    } catch (Exception e){
        env.build_ok = false
        sh 'echo "Lighttpd Example Test Failed"'
    }

    try {
        timeout(time: 10, unit: 'MINUTES') {
            sh '''
                cd CI-Examples/nginx
                make ${MAKEOPTS} ${ARCH_LIB_OPT} all
                make ${MAKEOPTS} start-gramine-server &
                ../../Scripts/wait_for_server 5 127.0.0.1 8002
                LOOP=1 CONCURRENCY_LIST="1 32" ../common_tools/benchmark-http.sh 127.0.0.1:8002
            '''
        }
    } catch (Exception e){
        env.build_ok = false
        sh 'echo "NGINX Example Test Failed"'
    }

    try {    
        timeout(time: 5, unit: 'MINUTES') {
            sh '''
                cd CI-Examples/blender
                make ${MAKEOPTS} ${ARCH_LIB_OPT} all
                make check
            '''
        }
    } catch (Exception e){
        env.build_ok = false
        sh 'echo "Blender Example Test Failed"'
    }

    try{
        timeout(time: 5, unit: 'MINUTES') {
            sh '''
                cd CI-Examples/sqlite
                make ${MAKEOPTS} ${ARCH_LIB_OPT} all
                make ${MAKEOPTS} regression
            '''
        }
    } catch (Exception e){
        env.build_ok = false
        sh 'echo "SQLite Example Test Failed"'
    }

    if(env.no_cpu.toInteger() > 16) 
    { 
        try{
            timeout(time: 5, unit: 'MINUTES') {
                sh '''
                    cd CI-Examples/go_helloworld
                    make check
                '''
            }
        } catch (Exception e){
            env.build_ok = false
            sh 'echo "go_helloworld Example Test Failed"'
        }
    }
}
